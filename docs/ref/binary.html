<!DOCTYPE  html>
<html>
  <head>
    <meta charset="utf-8">
    
    <title>doc</title>
    <style>
      /*github.com style (c) Vasily Polovnyov <vast@whiteants.net>*/
      pre code {
        display: block; padding: 0.5em;
        color: #333;
        background: #f8f8ff
      }
      pre .comment,
      pre .template_comment,
      pre .diff .header,
      pre .javadoc {
        color: #998;
        font-style: italic
      }
      pre .keyword,
      pre .css .rule .keyword,
      pre .winutils,
      pre .javascript .title,
      pre .nginx .title,
      pre .subst,
      pre .request,
      pre .status {
        color: #333;
        font-weight: bold
      }
      pre .number,
      pre .hexcolor,
      pre .ruby .constant {
        color: #099;
      }
      pre .string,
      pre .tag .value,
      pre .phpdoc,
      pre .tex .formula {
        color: #d14
      }
      pre .title,
      pre .id {
        color: #900;
        font-weight: bold
      }
      pre .javascript .title,
      pre .lisp .title,
      pre .clojure .title,
      pre .subst {
        font-weight: normal
      }
      pre .class .title,
      pre .haskell .type,
      pre .vhdl .literal,
      pre .tex .command {
        color: #458;
        font-weight: bold
      }
      pre .tag,
      pre .tag .title,
      pre .rules .property,
      pre .django .tag .keyword {
        color: #000080;
        font-weight: normal
      }
      pre .attribute,
      pre .variable,
      pre .lisp .body {
        color: #008080
      }
      pre .regexp {
        color: #009926
      }
      pre .class {
        color: #458;
        font-weight: bold
      }
      pre .symbol,
      pre .ruby .symbol .string,
      pre .lisp .keyword,
      pre .tex .special,
      pre .prompt {
        color: #990073
      }
      pre .built_in,
      pre .lisp .title,
      pre .clojure .built_in {
        color: #0086b3
      }
      pre .preprocessor,
      pre .pi,
      pre .doctype,
      pre .shebang,
      pre .cdata {
        color: #999;
        font-weight: bold
      }
      pre .deletion {
        background: #fdd
      }
      pre .addition {
        background: #dfd
      }
      pre .diff .change {
        background: #0086b3
      }
      pre .chunk {
        color: #aaa
      }
    </style>
  </head>
  <body>  
    <h1 id="binary-layout">Binary Layout</h1>
<pre><code>              &lt;------------- MIDI Chunk --------------&gt; &lt;-----Track Header----&gt; &lt;-Track data-&gt; {Track out&gt;
Byte number   0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 [22 to x]      [x+1 to x+4]
Byte data     4D 54 68 64 00 00 00 06 00 01 00 01 00 80 4D 54 72 6B 00 00 00 0A blah blah..... 00 FF 2F 00
MIDI section  A---------&gt; B---------&gt; C---&gt; D---&gt; E---&gt; F---------&gt; G---------&gt; H------------&gt; I---------&gt;</code></pre>
<h2 id="integer-representations">Integer Representations</h2>
<p><a name="varint"></a></p>
<h3 id="variable-length-integers">Variable-Length Integers</h3>
<p>In many places, an integer is used to specify the length of some piece
of data. Because the data length is arbitrary, the number of bytes
needed to represent the integer varies as well. Thus, the following scheme
is used so that the integer may be unambiguously decoded.</p>
<p>A <em>variable-length integer</em> is a sequence of 8-bit values, where the
most-significant bit represents &quot;more to follow&quot;, and the next 7 bits
are value bits.</p>
<h4 id="encoding-example">Encoding Example</h4>
<p>To encode the number 150 = (96)<sub>16</sub> = (10010110)<sub>2</sub>, 
we would split the value into 7-bit chunks (starting at the left side),
and set the &quot;more&quot; bit on each chunk to 1, <strong>except</strong> for the last chunk.</p>
<pre><code>         | Chunk 1 | Chunk 2 |    |  Value 1 |  Value 2 |
 0x96 =&gt; |---------|---------| =&gt; |----------|----------| =&gt; 0x81, 0x16
         |       1 | 0010110 |    | 10000001 | 00010110 |</code></pre>
<h4 id="decoding-example">Decoding Example</h4>
<p>Given the sequence <code>0xBD, 0x84 0x40</code>:</p>
<pre><code>|  Value 1 |  Value 2 |  Value 3 |    | Chunk 1 | Chunk 2 | Chunk 3 |
|----------|----------|----------| =&gt; |---------|---------|---------|
| 10111101 | 10000100 | 01000000 |    | 0111101 | 0000100 | 1000000 |</code></pre>
<p>Next, we combine the chunks in order to get the binary <code>011110100001001000000</code>.</p>
<pre><code>011110100001001000000 =&gt;  0 1111 0100 0010 0100 0000 =&gt; 0xF4240 =&gt; 10,000</code></pre>
<h2 id="the-header-chunk">The Header Chunk</h2>
<pre><code>              &lt;----------- Header Chunk --------------&gt;
Byte number   0  1  2  3  4  5  6  7  8  9  10 11 12 13
Byte data     4D 54 68 64 00 00 00 06 00 01 00 01 00 80
MIDI section  A---------&gt; B---------&gt; C---&gt; D---&gt; E---&gt;</code></pre>
<p>The header is made up of (at least) 13 bytes of data, comprised of:</p>
<ul>
<li>(Section A) The ASCII string <code>MThd</code></li>
<li>(Section B) A four-byte integer specifying the number of bytes remaining in the header
(This value is almost always 6)</li>
<li>(Section C) A two-byte integer specifying the type of the MIDI file.
(We recognize only 0 and 1)</li>
<li>(Section D) A two-byte integer specifying the number of <em>tracks</em> in the
file. (A Type-0 file must specify 1 here)</li>
<li>(Section E) A two-byte integer which represents the <em>time division</em> of the 
file. There are two different representations for time division, as explained
in the next section</li>
</ul>
<h3 id="time-division">Time Division</h3>
<p>The representation used for the time division section of the header is
determined by the most-significant bit of the two-byte value. If the
bit is 0, then the remaining 15 bits use the &quot;ticks per beat&quot;
representation. If it is 1, all 16 bits are used for the
&quot;frames per second&quot; representation.</p>
<h4 id="ticks-per-beat">Ticks per beat</h4>
<p>This is a single, 15-bit value that describes the number of &quot;ticks&quot;
in a single beat of music. This can only be translated to an actual
number of (milli)seconds by also knowing the <em>tempo</em> of the song,
which is measured in <em>beats per minute (bpm)</em>.</p>
<h4 id="frames-per-second">Frames per second</h4>
<p>The 16 bits of the time division are broken into 2 pieces:</p>
<ol>
<li>The top 8 bits define the number of [SMPTE frames][SMPTE],
and must be one of the following values:<ul>
<li><code>-24</code> (<code>0xE8</code>)</li>
<li><code>-25</code> (<code>0xE7</code>)</li>
<li><code>-29</code> (<code>0xE3</code>) - Note that this actually translates to 29.97</li>
<li><code>-30</code> (<code>0xE2</code>) </li>
</ul>
</li>
<li>The lower byte is an (unsigned) value measuring the number of &quot;ticks&quot; per
frame.</li>
</ol>
<h2 id="track-chunks">Track Chunks</h2>
<pre><code>              &lt;-----Track Header----&gt; &lt;-Track data-&gt; {Track out&gt;
Byte number   14 15 16 17 18 19 20 21 .............. 28 29 30 31
Byte data     4D 54 72 6B 00 00 00 0A .............. 00 FF 2F 00
MIDI section  F---------&gt; G---------&gt; H------------&gt; I---------&gt;</code></pre>
<h3 id="track-header">Track Header</h3>
<pre><code>              &lt;-----Track Header----&gt;
Byte number   14 15 16 17 18 19 20 21
Byte data     4D 54 72 6B 00 00 00 0A
MIDI section  A---------&gt; B---------&gt;</code></pre>
<p>The track header is made up of exactly 8 bytes of data, containing:</p>
<ul>
<li>(Section A) The ASCII string <code>MTrk</code></li>
<li>(Section B) A four-byte integer specifying the number of bytes in this track,<pre><code>        including the track footer.</code></pre>
</li>
</ul>
<h3 id="track-events">Track Events</h3>
<h3 id="track-footer">Track Footer</h3>
<p>TODO</p>
<h2 id="events">Events</h2>
<p>The <em>delta time</em> is stored as a <a href="#varint">variable-length integer</a>.</p>
<h3 id="channel-messages">Channel Messages</h3>
<p>A channel message has the following format:</p>
<p><code>&lt;type&gt; &lt;channel&gt; &lt;data&gt;</code></p>
<p>Where:</p>
<ul>
<li><em>message</em> is a 4-bit quantity in the range <code>0x8</code>&ndash;<code>0xE</code>.</li>
<li><em>channel</em> is a 4-bit quantity in the range <code>0x0</code>&ndash;<code>0xF</code>.</li>
<li><em>data</em> is either 1 or 2 bytes of data, split into the <em>parameters</em>
of the particular message.</li>
</ul>
<p>These are the 7 defined channel messages:</p>
<table>
<thead>
<tr>
<th>Message</th>
<th>Status</th>
<th>Byte 1</th>
<th>Byte 2</th>
</tr>
</thead>
<tbody>
<tr>
<td>Note Off</td>
<td><code>0x8</code></td>
<td><code>note</code></td>
<td><code>velocity</code></td>
</tr>
<tr>
<td>Note On</td>
<td><code>0x9</code></td>
<td><code>note</code></td>
<td><code>velocity</code></td>
</tr>
<tr>
<td>After Touch</td>
<td><code>0xA</code></td>
<td><code>note</code></td>
<td><code>amount</code></td>
</tr>
<tr>
<td>Control Change</td>
<td><code>0xB</code></td>
<td><code>controller</code></td>
<td><code>value</code></td>
</tr>
<tr>
<td>Program  Change</td>
<td><code>0xC</code></td>
<td><code>program</code></td>
<td>N/A</td>
</tr>
<tr>
<td>Channel Pressure</td>
<td><code>0xD</code></td>
<td><code>amount</code></td>
<td>N/A</td>
</tr>
<tr>
<td>Pitch Wheel</td>
<td><code>0xE</code></td>
<td><code>pitchValue1</code></td>
<td><code>pitchValue2</code></td>
</tr>
</tbody>
</table>
<h2 id="references">References</h2>
<ul>
<li><a href="http://en.wikipedia.org/wiki/MIDI_timecode">Wikipedia - MIDI Timecode</a></li>
<li><a href="http://www.sonicspot.com/guide/midifiles.html">MIDI File Format at &quot;The Sonic Spot&quot;</a></li>
<li><a href="http://cs.fit.edu/~ryan/cse4051/projects/midi/midi.html">The MIDI File Format at Stanford</a></li>
<li><a href="https://groups.google.com/forum/#!topic/music21list/f9AboXHW0QE">Google Groups discussion of timing</a>
[SMPTE]: ../MIDI.html#SMPTE &quot;SMPTE Definition&quot;</li>
</ul>

  </body>
</html>
